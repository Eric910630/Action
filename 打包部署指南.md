# é¡¹ç›®æ‰“åŒ…éƒ¨ç½²æŒ‡å—

æœ¬æ–‡æ¡£æä¾›å¤šç§æ–¹å¼å°†é¡¹ç›®æ‰“åŒ…æˆå¯æ‰§è¡Œåº”ç”¨ï¼Œä¾›ä»–äººä½¿ç”¨ã€‚

---

## æ–¹æ¡ˆä¸€ï¼šDocker Composeï¼ˆæ¨èï¼‰â­

**ä¼˜ç‚¹**ï¼šæœ€ç®€å•ã€æœ€å¯é ï¼Œä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡  
**é€‚ç”¨åœºæ™¯**ï¼šç”¨æˆ·å·²å®‰è£…Docker Desktop

### 1. åˆ›å»ºå®Œæ•´çš„Dockeré…ç½®

#### æ›´æ–° `docker/docker-compose.yml`

```yaml
version: '3.8'

services:
  # PostgreSQLæ•°æ®åº“
  postgres:
    image: postgres:15-alpine
    container_name: vtics-postgres
    environment:
      POSTGRES_USER: vtics
      POSTGRES_PASSWORD: vtics123
      POSTGRES_DB: vtics
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - vtics-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vtics"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis
  redis:
    image: redis:7-alpine
    container_name: vtics-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - vtics-network
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # åç«¯APIæœåŠ¡
  backend:
    build:
      context: ../backend
      dockerfile: ../docker/Dockerfile.backend
    container_name: vtics-backend
    ports:
      - "8001:8001"
    environment:
      - DATABASE_URL=postgresql+psycopg2://vtics:vtics123@postgres:5432/vtics
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    volumes:
      - ../backend:/app
      - uploads_data:/app/uploads
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - vtics-network
    command: uvicorn app.main:app --host 0.0.0.0 --port 8001

  # Celery Worker
  celery-worker:
    build:
      context: ../backend
      dockerfile: ../docker/Dockerfile.backend
    container_name: vtics-celery-worker
    environment:
      - DATABASE_URL=postgresql+psycopg2://vtics:vtics123@postgres:5432/vtics
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    volumes:
      - ../backend:/app
      - uploads_data:/app/uploads
    depends_on:
      - postgres
      - redis
      - backend
    networks:
      - vtics-network
    command: celery -A app.celery_app worker --loglevel=info --pool=solo

  # Celery Beat (å®šæ—¶ä»»åŠ¡)
  celery-beat:
    build:
      context: ../backend
      dockerfile: ../docker/Dockerfile.backend
    container_name: vtics-celery-beat
    environment:
      - DATABASE_URL=postgresql+psycopg2://vtics:vtics123@postgres:5432/vtics
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    volumes:
      - ../backend:/app
    depends_on:
      - postgres
      - redis
      - backend
    networks:
      - vtics-network
    command: celery -A app.celery_app beat --loglevel=info

  # å‰ç«¯æœåŠ¡ï¼ˆNginxï¼‰
  frontend:
    build:
      context: ../frontend
      dockerfile: ../docker/Dockerfile.frontend
    container_name: vtics-frontend
    ports:
      - "3001:80"
    depends_on:
      - backend
    networks:
      - vtics-network

volumes:
  postgres_data:
  redis_data:
  uploads_data:

networks:
  vtics-network:
    driver: bridge
```

### 2. åˆ›å»ºå‰ç«¯Dockerfile

åˆ›å»º `docker/Dockerfile.frontend`ï¼š

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:18-alpine AS builder

WORKDIR /app

# å¤åˆ¶packageæ–‡ä»¶
COPY package*.json ./
RUN npm ci

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»º
RUN npm run build

# è¿è¡Œé˜¶æ®µ
FROM nginx:alpine

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/dist /usr/share/nginx/html

# å¤åˆ¶nginxé…ç½®
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

### 3. åˆ›å»ºNginxé…ç½®

åˆ›å»º `docker/nginx.conf`ï¼š

```nginx
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://backend:8001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 4. åˆ›å»ºå¯åŠ¨è„šæœ¬

åˆ›å»º `docker/start.sh`ï¼š

```bash
#!/bin/bash

echo "=========================================="
echo "å¯åŠ¨ VTICS åº”ç”¨"
echo "=========================================="

# æ£€æŸ¥Docker
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Docker Desktop"
    echo "   ä¸‹è½½åœ°å€: https://www.docker.com/products/docker-desktop"
    exit 1
fi

# æ£€æŸ¥Docker Compose
if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
    echo "âŒ Docker Compose æœªå®‰è£…"
    exit 1
fi

# è¿›å…¥dockerç›®å½•
cd "$(dirname "$0")"

# æ„å»ºå¹¶å¯åŠ¨
echo "ğŸ“¦ æ„å»ºé•œåƒ..."
docker-compose build

echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
docker-compose up -d

echo ""
echo "âœ… æœåŠ¡å·²å¯åŠ¨ï¼"
echo ""
echo "è®¿é—®åœ°å€:"
echo "  å‰ç«¯é¡µé¢: http://localhost:3001"
echo "  APIæ–‡æ¡£: http://localhost:8001/docs"
echo ""
echo "æŸ¥çœ‹æ—¥å¿—: docker-compose logs -f"
echo "åœæ­¢æœåŠ¡: docker-compose down"
echo ""
```

### 5. ä½¿ç”¨æ–¹æ³•

```bash
# 1. è¿›å…¥dockerç›®å½•
cd docker

# 2. è¿è¡Œå¯åŠ¨è„šæœ¬
chmod +x start.sh
./start.sh

# æˆ–è€…ç›´æ¥ä½¿ç”¨docker-compose
docker-compose up -d
```

---

## æ–¹æ¡ˆäºŒï¼šä¸€é”®å¯åŠ¨è„šæœ¬ï¼ˆæ— Dockerï¼‰

**ä¼˜ç‚¹**ï¼šä¸éœ€è¦Dockerï¼Œé€‚åˆæœ¬åœ°å¼€å‘  
**é€‚ç”¨åœºæ™¯**ï¼šç”¨æˆ·æœ‰Pythonå’ŒNode.jsç¯å¢ƒ

### åˆ›å»º `start_app.sh`

```bash
#!/bin/bash

echo "=========================================="
echo "å¯åŠ¨ VTICS åº”ç”¨"
echo "=========================================="

# æ£€æŸ¥ä¾èµ–
check_dependency() {
    if ! command -v $1 &> /dev/null; then
        echo "âŒ $1 æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… $1"
        exit 1
    fi
}

check_dependency python3
check_dependency node
check_dependency npm

# æ£€æŸ¥PostgreSQLå’ŒRedis
if ! pg_isready -h localhost -p 5432 &> /dev/null; then
    echo "âš ï¸  PostgreSQLæœªè¿è¡Œï¼Œè¯·å…ˆå¯åŠ¨PostgreSQL"
fi

if ! redis-cli ping &> /dev/null; then
    echo "âš ï¸  Redisæœªè¿è¡Œï¼Œè¯·å…ˆå¯åŠ¨Redis"
fi

# å®‰è£…åç«¯ä¾èµ–
echo "ğŸ“¦ å®‰è£…åç«¯ä¾èµ–..."
cd backend
if [ ! -d "venv" ]; then
    python3 -m venv venv
fi
source venv/bin/activate
pip install -r requirements.txt

# å®‰è£…å‰ç«¯ä¾èµ–
echo "ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–..."
cd ../frontend
if [ ! -d "node_modules" ]; then
    npm install
fi

# æ„å»ºå‰ç«¯
echo "ğŸ“¦ æ„å»ºå‰ç«¯..."
npm run build

# å¯åŠ¨æœåŠ¡
echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
cd ../backend
source venv/bin/activate

# å¯åŠ¨åç«¯ï¼ˆåå°ï¼‰
uvicorn app.main:app --host 0.0.0.0 --port 8001 > ../logs/backend.log 2>&1 &
BACKEND_PID=$!

# å¯åŠ¨Celery Workerï¼ˆåå°ï¼‰
celery -A app.celery_app worker --loglevel=info --pool=solo > ../logs/celery.log 2>&1 &
CELERY_PID=$!

# å¯åŠ¨Celery Beatï¼ˆåå°ï¼‰
celery -A app.celery_app beat --loglevel=info > ../logs/celery-beat.log 2>&1 &
BEAT_PID=$!

# å¯åŠ¨å‰ç«¯ï¼ˆä½¿ç”¨serveï¼‰
cd ../frontend
npx serve -s dist -l 3001 > ../logs/frontend.log 2>&1 &
FRONTEND_PID=$!

# ä¿å­˜PID
echo $BACKEND_PID > ../logs/backend.pid
echo $CELERY_PID > ../logs/celery.pid
echo $BEAT_PID > ../logs/celery-beat.pid
echo $FRONTEND_PID > ../logs/frontend.pid

echo ""
echo "âœ… æœåŠ¡å·²å¯åŠ¨ï¼"
echo ""
echo "è®¿é—®åœ°å€:"
echo "  å‰ç«¯é¡µé¢: http://localhost:3001"
echo "  APIæ–‡æ¡£: http://localhost:8001/docs"
echo ""
echo "åœæ­¢æœåŠ¡: ./stop_app.sh"
echo ""
```

---

## æ–¹æ¡ˆä¸‰ï¼šæ¡Œé¢åº”ç”¨ï¼ˆElectronï¼‰

**ä¼˜ç‚¹**ï¼šåƒæ™®é€šè½¯ä»¶ä¸€æ ·å®‰è£…ä½¿ç”¨  
**é€‚ç”¨åœºæ™¯**ï¼šæƒ³è¦æ¡Œé¢åº”ç”¨ä½“éªŒ

### 1. å®‰è£…Electronä¾èµ–

```bash
cd frontend
npm install --save-dev electron electron-builder
```

### 2. åˆ›å»ºElectronä¸»è¿›ç¨‹

åˆ›å»º `frontend/electron/main.js`ï¼š

```javascript
const { app, BrowserWindow } = require('electron')
const path = require('path')
const { spawn } = require('child_process')

let mainWindow
let backendProcess

function createWindow() {
  mainWindow = new BrowserWindow({
    width: 1400,
    height: 900,
    webPreferences: {
      nodeIntegration: false,
      contextIsolation: true
    }
  })

  // å¯åŠ¨åç«¯æœåŠ¡
  startBackend()

  // ç­‰å¾…åç«¯å¯åŠ¨ååŠ è½½å‰ç«¯
  setTimeout(() => {
    mainWindow.loadURL('http://localhost:3001')
  }, 5000)
}

function startBackend() {
  const backendPath = path.join(__dirname, '../../backend')
  backendProcess = spawn('python3', [
    '-m', 'uvicorn',
    'app.main:app',
    '--host', '0.0.0.0',
    '--port', '8001'
  ], {
    cwd: backendPath
  })
}

app.whenReady().then(createWindow)

app.on('window-all-closed', () => {
  if (process.platform !== 'darwin') {
    app.quit()
  }
})

app.on('before-quit', () => {
  if (backendProcess) {
    backendProcess.kill()
  }
})
```

### 3. é…ç½®Electron Builder

åœ¨ `frontend/package.json` ä¸­æ·»åŠ ï¼š

```json
{
  "main": "electron/main.js",
  "scripts": {
    "electron": "electron .",
    "electron:build": "electron-builder"
  },
  "build": {
    "appId": "com.vtics.app",
    "productName": "VTICS",
    "directories": {
      "output": "dist-electron"
    },
    "files": [
      "dist/**/*",
      "electron/**/*",
      "node_modules/**/*"
    ],
    "mac": {
      "target": "dmg"
    },
    "win": {
      "target": "nsis"
    },
    "linux": {
      "target": "AppImage"
    }
  }
}
```

---

## æ–¹æ¡ˆå››ï¼šå®‰è£…åŒ…ï¼ˆmacOS/Windowsï¼‰

### macOS: ä½¿ç”¨create-dmg

```bash
npm install -g create-dmg

# åˆ›å»ºDMGå®‰è£…åŒ…
create-dmg \
  --volname "VTICS" \
  --window-pos 200 120 \
  --window-size 800 400 \
  --icon-size 100 \
  --icon "VTICS.app" 200 190 \
  --hide-extension "VTICS.app" \
  --app-drop-link 600 185 \
  "VTICS-Installer.dmg" \
  "dist/"
```

### Windows: ä½¿ç”¨Inno Setup

åˆ›å»º `installer.iss`ï¼š

```iss
[Setup]
AppName=VTICS
AppVersion=1.0.0
DefaultDirName={pf}\VTICS
DefaultGroupName=VTICS
OutputDir=installer
OutputBaseFilename=VTICS-Setup

[Files]
Source: "dist\*"; DestDir: "{app}"; Flags: recursesubdirs

[Icons]
Name: "{group}\VTICS"; Filename: "{app}\VTICS.exe"
```

---

## æ¨èæ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | éš¾åº¦ | ç”¨æˆ·å‹å¥½åº¦ | é€‚ç”¨åœºæ™¯ |
|------|------|-----------|---------|
| Docker Compose | â­â­ | â­â­â­â­ | æœ‰Dockerçš„ç”¨æˆ· |
| ä¸€é”®å¯åŠ¨è„šæœ¬ | â­â­â­ | â­â­â­ | å¼€å‘è€…/æŠ€æœ¯äººå‘˜ |
| Electronæ¡Œé¢åº”ç”¨ | â­â­â­â­ | â­â­â­â­â­ | æ™®é€šç”¨æˆ· |
| å®‰è£…åŒ… | â­â­â­â­â­ | â­â­â­â­â­ | æœ€ç»ˆç”¨æˆ· |

---

## å¿«é€Ÿæ‰“åŒ…æ­¥éª¤ï¼ˆæ¨èï¼šDocker Composeï¼‰

1. **å‡†å¤‡æ–‡ä»¶**ï¼š
   - æ›´æ–° `docker/docker-compose.yml`
   - åˆ›å»º `docker/Dockerfile.frontend`
   - åˆ›å»º `docker/nginx.conf`
   - åˆ›å»º `docker/start.sh`

2. **æ‰“åŒ…é¡¹ç›®**ï¼š
   ```bash
   # åˆ›å»ºå‘å¸ƒåŒ…
   tar -czf VTICS-v1.0.0.tar.gz \
     --exclude='node_modules' \
     --exclude='venv' \
     --exclude='.git' \
     --exclude='*.log' \
     --exclude='__pycache__' \
     --exclude='.pytest_cache' \
     Action/
   ```

3. **ç”¨æˆ·ä½¿ç”¨**ï¼š
   ```bash
   # è§£å‹
   tar -xzf VTICS-v1.0.0.tar.gz
   cd Action/docker
   
   # å¯åŠ¨
   chmod +x start.sh
   ./start.sh
   ```

---

## æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒå˜é‡**ï¼šç”¨æˆ·éœ€è¦é…ç½® `.env` æ–‡ä»¶ï¼ˆDeepSeek API Keyç­‰ï¼‰
2. **æ•°æ®åº“åˆå§‹åŒ–**ï¼šé¦–æ¬¡å¯åŠ¨éœ€è¦è¿è¡Œæ•°æ®åº“è¿ç§»
3. **ç«¯å£å ç”¨**ï¼šç¡®ä¿8001ã€3001ã€5432ã€6379ç«¯å£æœªè¢«å ç”¨
4. **ç³»ç»Ÿè¦æ±‚**ï¼š
   - Docker Desktopï¼ˆæ–¹æ¡ˆä¸€ï¼‰
   - Python 3.10+ã€Node.js 16+ã€PostgreSQLã€Redisï¼ˆæ–¹æ¡ˆäºŒï¼‰

---

**å»ºè®®**ï¼šä¼˜å…ˆä½¿ç”¨Docker Composeæ–¹æ¡ˆï¼Œæœ€ç®€å•å¯é ã€‚

