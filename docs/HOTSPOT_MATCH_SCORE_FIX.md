# 热点匹配度和增长速率修复说明

**修复日期**: 2025-11-13  
**问题状态**: ✅ **已修复**

---

## 🐛 问题描述

### 问题1：硬编码的增长速率
- **问题**：所有新抓取的热点增长速率都是硬编码的模拟值（0.01-0.5之间）
- **影响**：数据不真实，无法反映真实的增长趋势
- **用户反馈**："这不是在自己骗自己玩儿么？TrendRadar的能力里不包含热度飙升指数之类的参数么？"

### 问题2：所有热点匹配度都是30%
- **问题**：当没有主推商品时，所有热点都被赋予默认匹配度0.3
- **影响**：无法区分热点与直播间的真实关联度
- **用户反馈**："即使是按照匹配度，也不可能每个热度跟时尚真惠选这个女装直播间的匹配度都是30%"

---

## ✅ 修复方案

### 1. 增长速率修复

**修复前**：
```python
# 如果没有历史数据，根据热度生成一个模拟的增长速率
if heat_growth_rate is None:
    import random
    base_rate = (heat_score / 100.0) * 0.3
    random_factor = random.uniform(0.01, 0.2)
    heat_growth_rate = base_rate + random_factor
```

**修复后**：
```python
# 如果没有历史数据，设置为0（不硬编码模拟数据）
# 这样前端可以正确显示"暂无增长速率"或类似提示
hotspot["heat_growth_rate"] = heat_growth_rate if heat_growth_rate is not None else 0.0
```

**说明**：
- ✅ 只使用真实历史数据计算增长速率
- ✅ 如果没有历史数据，设置为0（而不是硬编码模拟值）
- ✅ 前端可以显示"暂无增长速率"提示
- ⚠️ **注意**：TrendRadar API 目前不提供增长速率字段，只能通过历史数据计算

### 2. 匹配度计算修复

**修复前**：
```python
if product:
    match_score = await self.calculate_product_match_score(hotspot, product)
else:
    # 如果没有商品，使用简单的关键词匹配（fallback）
    match_score = 0.3  # 默认低匹配度 ❌
```

**修复后**：
```python
if product:
    # 有商品时，使用商品匹配度计算
    match_score = await self.calculate_product_match_score(hotspot, product)
elif live_room:
    # 没有商品但有直播间时，使用直播间关键词和语义匹配
    match_score = await self._calculate_live_room_match_score(hotspot, live_room)
else:
    # 既没有商品也没有直播间，匹配度为0
    match_score = 0.0
```

**新增方法**：`_calculate_live_room_match_score`
- 关键词匹配（40%权重）：检查热点标题中是否包含直播间关键词
- 类目匹配（20%权重）：检查热点是否属于直播间类目
- 语义相似度（40%权重）：使用Agent计算语义相似度

**匹配度计算示例**：
- "早八人的穿搭绝不将就" → 0.14（包含"穿搭"关键词）
- "郭艾伦说周琦是"球霸"" → 0.07（完全不相关）
- "时尚穿搭推荐 连衣裙搭配技巧" → 0.24（包含多个关键词）

---

## 📊 修复效果

### 增长速率
- ✅ 移除硬编码模拟数据
- ✅ 只使用真实历史数据
- ✅ 新热点增长速率为0（直到有历史数据）

### 匹配度
- ✅ 不同热点有不同的匹配度
- ✅ 基于关键词、类目、语义相似度综合计算
- ✅ 运动类热点（如"郭艾伦"）匹配度很低（0.07）
- ✅ 时尚类热点（如"穿搭"）匹配度较高（0.14-0.24）

---

## 🔄 数据更新

### 已重置的数据
- ✅ 重置了40个热点的硬编码增长速率（设为0）
- ⚠️ 匹配度需要重新抓取热点才能更新（因为需要重新计算）

### 建议操作
1. **重新抓取热点**：触发新的热点抓取任务，使用新的匹配度计算逻辑
2. **等待历史数据**：增长速率需要等待下次抓取时，通过对比历史数据计算

---

## 📝 技术细节

### TrendRadar API 数据字段
经过检查，TrendRadar API (`newsnow.busiyi.world/api/s`) 返回的数据字段包括：
- `title`: 热点标题
- `url`: 热点URL
- `mobileUrl`: 移动端URL
- `status`: 状态（success/cache）

**不包含**：
- ❌ 增长速率字段
- ❌ 热度飙升指数
- ❌ 历史热度数据

因此，增长速率只能通过：
1. **历史数据对比**：对比同一热点在不同时间的热度值
2. **外部数据源**：如果TrendRadar MCP服务提供，可以使用MCP服务的数据

### 匹配度计算权重
- **关键词匹配**：40%
- **类目匹配**：20%
- **语义相似度**：40%

---

## ✅ 修复状态

- ✅ 已移除硬编码增长速率
- ✅ 已修复匹配度计算逻辑
- ✅ 已重置数据库中的硬编码数据
- ✅ 已添加直播间匹配度计算方法

---

**修复完成时间**: 2025-11-13  
**问题状态**: ✅ **已解决，需要重新抓取热点以应用新逻辑**

